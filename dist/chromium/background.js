"use strict";(()=>{var c="https://www.bing.com/",I="https://cn.bing.com/",N=["zh-CN","ru","ru-ru"],b="113",x="113.0.1774.57",A=["csp_report","font","image","main_frame","media","object","other","ping","script","stylesheet","sub_frame","webbundle","websocket","webtransport","xmlhttprequest"];var v="2.0.2";var d={type:"git",url:"https://github.com/haozi/New-Bing-Anywhere"};var j=()=>{try{return chrome.i18n.getUILanguage().toLowerCase()==="zh-cn"}catch{return!1}},z=()=>{try{let e=chrome.i18n.getUILanguage().toLowerCase();return e==="zh-cn"||e==="zh-tw"||e==="zh-hk"||e==="zh"}catch{return!1}};var P="configV1",K=async()=>({showGoogleButtonOnBing:!0,showBingButtonOnGoogle:!0,showGuideToGithub:!0,showChat:!0,triggerMode:"Always",conversationStyle:"Balanced",...(await chrome.storage.sync.get(P))[P]});var L=e=>{chrome.runtime.onMessage.addListener((t,r,n)=>((async()=>{try{let{method:o,args:i}=t,s=await e[o](...i);n({code:200,msg:"ok",data:s})}catch(o){let i=o??{};n({code:500,msg:i.stack??i.message??o})}})(),!0))};var oe=(()=>{let e="v1";return{get:async t=>{t=`${e}:${t}`;let{data:r,maxAge:n,lastModified:o}=(await chrome.storage.local.get(t))?.[t]??{};return Date.now()-o>n*1e3?(chrome.storage.local.remove(t),null):r},set:async(t,r,n=1/0)=>{t=`${e}:${t}`,await chrome.storage.local.set({[t]:{data:r,lastModified:Date.now(),maxAge:n}})}}})();var h=navigator.userAgent,W=navigator.userAgentData,Y=h.includes("Macintosh"),ie=h.includes("Firefox"),F=h.includes("Edg/"),se=W?.brands.findIndex(e=>e.brand==="Brave")>-1,T=z(),U=j(),f=!!globalThis.__NBA_isCanary,p=f?`0.${v}`:v,_=()=>{let e=h;return F||(Y?e=`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${b}.0.0.0 Safari/537.36 Edg/${x}`:e=`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${b}.0.0.0 Safari/537.36 Edg/${x}`),e},E=async e=>{let t=d.url;try{let r=await K(),o=`${t}/issues/new?title=&body=`,i="Please write your comment ABOVE this line, provide as much detailed information and screenshots as possible.The UA may not necessarily reflect your actual browser and platform, so please make sure to indicate them clearly.";T&&(i="\u8BF7\u5728\u6B64\u884C\u4E0A\u65B9\u53D1\u8868\u60A8\u7684\u8BA8\u8BBA\u3002\u8BE6\u5C3D\u7684\u63CF\u8FF0\u548C\u622A\u56FE\u6709\u52A9\u4E8E\u6211\u4EEC\u5B9A\u4F4D\u95EE\u9898\uFF0CUA \u4E0D\u4E00\u5B9A\u771F\u5B9E\u53CD\u6620\u60A8\u7684\u6D4F\u89C8\u5668\u548C\u5E73\u53F0\uFF0C\u8BF7\u5907\u6CE8\u6E05\u695A");let s=` 



<!--  ${i} -->
`+Object.entries({Version:`${p}${f?" (Canary)":""} `,UA:navigator.userAgent,Lang:chrome.i18n.getUILanguage(),AcceptLangs:(await chrome.i18n.getAcceptLanguages()).join(", "),config:JSON.stringify(r),...e}).map(([g,m])=>m?`${g}: ${m}`:"").join(`
`);return o+=encodeURIComponent(s.slice(0,2e3)),o}catch{return t}};var l=(e="",t)=>{try{return new URL(e,t)}catch{return{searchParams:{get:()=>null}}}},C=e=>{try{return new URLSearchParams(e)}catch{return{get:()=>null}}},a=async e=>{let t=await chrome.tabs.query({currentWindow:!0}),r=l(e),n=t.find(o=>o.url?.startsWith(r.origin));return n==null?n=await chrome.tabs.create({url:e}):await Promise.all([chrome.tabs.move(n.id,{index:t.length-1}),n.url!==e&&chrome.tabs.update(n.id,{url:e}),chrome.tabs.update(n.id,{active:!0,url:n.url!==e?e:void 0})].filter(Boolean)),n},w=async(e,t={})=>await chrome.cookies.set({domain:t.domain,storeId:t.storeId,path:t.path,httpOnly:t.httpOnly,secure:t.secure,sameSite:t.sameSite,expirationDate:t.expirationDate,...e});var M={openChat:{title:"\u{1F4AC} New Bing",contexts:["action"],onclick:e=>{a("https://www.bing.com/search?q=Bing+AI&showconv=1")}},openImageCreate:{title:"\u{1F5BC}\uFE0F New Bing Image Creator",contexts:["action"],onclick:e=>{a("https://www.bing.com/create")}},likeIt:{title:"\u2764\uFE0F Like it",contexts:["action"],onclick:()=>{a("https://chrome.google.com/webstore/detail/new-bing-anywhere/hceobhjokpdbogjkplmfjeomkeckkngi/reviews")}},reportIssues:{title:T?"\u{1F41B} \u53CD\u9988\u5EFA\u8BAE":"\u{1F41B} Report issues",contexts:["action"],onclick:async e=>{let t=await E();a(t)}}},S=()=>{chrome.contextMenus.removeAll(()=>{for(let[e,t]of Object.entries(M))chrome.contextMenus.create({id:e,title:t.title,contexts:t.contexts})}),chrome.contextMenus.onClicked.addListener((e,t)=>{let{menuItemId:r}=e,n=M[r];n?.onclick&&n.onclick(e,t)})};var u="notification",y="notification:hide",H=async()=>{let e;try{e=await fetch("https://api.github.com/repos/haozi/New-Bing-Anywhere/issues/24").then(async t=>await t.json())}catch{}return e},D=async()=>{let{[u]:e}=await chrome.storage.local.get(u);if(!e||e.lastModify&&Date.now()-e.lastModify>36e5){await chrome.storage.local.remove(u);let n=await H();n&&await chrome.storage.local.set({[u]:{data:n,lastModify:Date.now()}})}let{[y]:t,[u]:r}=await chrome.storage.local.get([y,u]);return!r?.data||!(r.data.title&&r.data.state==="open")||t===1&&r.data.title===e.data?.title?null:(await chrome.storage.local.remove(y),r.data)},k=async()=>{chrome.storage.local.set({[y]:1})};var V=async()=>({version:p}),Q=async({url:e}={})=>{let t=await chrome.tabs.query({currentWindow:!0}),r=l(e),n=t.find(G=>G.url?.startsWith(r.origin));n==null?n=await chrome.tabs.create({url:e}):n.id!=null&&await Promise.all([chrome.tabs.move(n.id,{index:t.length-1}),chrome.tabs.update(n.id,{active:!0})]);let o=e,i="",s="",g=r.hostname==="www.google.com",m=r.hostname==="www.bing.com";g?(i=r.searchParams.get("q")??"",s=l(n.url).searchParams.get("q")??"",l(n.url).searchParams.get("q")):m&&(i=r.searchParams.get("q")??"",s=l(n.url).searchParams.get("q")??""),i=i.trim(),s=s.trim(),!(i&&i===s)&&(g?o=`${r.origin}${r.pathname}?q=${encodeURIComponent(i)}`:m&&(o=`${r.origin}${r.pathname}?q=${encodeURIComponent(i)}`),await chrome.tabs.update(n.id,{url:o}))},$={getEnv:V,openUrlInSameTab:Q,getNotification:D,hideNotification:k};var O=()=>{S(),L($),chrome.runtime.onInstalled.addListener(e=>{let t=d.url;if(f){a(`${t}/tree/canary`);return}e.reason==="install"?a(t):e.reason==="update"&&a(`${t}/releases/tag/v${p}`)}),chrome.webRequest.onBeforeRequest.addListener(()=>{chrome.cookies.get({name:"_EDGE_S",url:c},e=>{let t=e?.value;if(!t)return;let r=C(t),n=r.get("mkt")?.toLowerCase()??"";N.map(o=>o.toLowerCase()).includes(n)&&(n==="zh-cn"?(r.set("mkt","zh-HK"),r.set("ui","zh-hans")):r.delete("mkt"),w({url:c,name:e.name,value:r.toString()},e))}),chrome.cookies.get({name:"_RwBf",url:c},e=>{let t=e?.value;if(!t){w({url:c,name:"_RwBf",value:"wls=2",domain:".bing.com",httpOnly:!0});return}let r=C(t),n=r.get("wls");n!=="2"&&n!==""&&r.set("wls","2"),w({url:c,name:"_RwBf",domain:".bing.com",httpOnly:!0,value:r.toString()},e)})},{urls:[c+"*"],types:["main_frame"]})};var X={"User-Agent":_()},J="modifyHeaders",Z="set",R=[{priority:2001,action:{type:J,requestHeaders:Object.entries(X).map(([e,t])=>({operation:Z,header:e,value:t}))},condition:{requestDomains:["bing.com","www.bing.com","cn.bing.com"],resourceTypes:A}}].filter(Boolean).map((e,t)=>({id:t+1+2e3,...e})),q=()=>{R.length&&chrome.declarativeNetRequest.getDynamicRules(e=>{chrome.declarativeNetRequest.updateDynamicRules({removeRuleIds:[...new Set([...R.map(t=>t.id),...e.map(t=>t.id)])],addRules:R})})};O();chrome.runtime.onInstalled.addListener(e=>{q()});U&&chrome.runtime.setUninstallURL(I);})();
